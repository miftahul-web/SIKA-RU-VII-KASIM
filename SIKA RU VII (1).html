<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Monitoring Area Kerja - Satelit (Izin Kerja)</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <!-- Leaflet Draw CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />

  <style>
    :root{
      --sidebar-w:360px;
      --accent:#0b5ed7;
      --bg:#f5f7fb;
    }
    html,body{height:100%;margin:0;font-family:Inter,Segoe UI,Roboto,Arial;background:var(--bg);color:#0f172a}
    header{background:var(--accent);color:#fff;padding:10px 12px;display:flex;align-items:center;gap:8px}
    header .title{flex:1;text-align:center;font-size:18px;font-weight:600}
    #app{display:flex;height:calc(100% - 52px)}
    .sidebar{width:var(--sidebar-w);min-width:220px;background:#fff;padding:12px;box-shadow:2px 0 10px rgba(10,10,10,.06);overflow:auto;z-index:2000}
    .map-wrap{flex:1;position:relative}
    #map{position:absolute;inset:0}
    label{display:block;font-size:13px;margin-top:8px}
    input,select,button,textarea{width:100%;padding:8px;border-radius:6px;border:1px solid #d1d7e0;margin-top:6px;font-size:14px;box-sizing:border-box}
    .row{display:flex;gap:8px}
    .row input{flex:1}
    .btn{padding:8px;border-radius:6px;border:none;cursor:pointer}
    .btn-primary{background:var(--accent);color:#fff}
    .btn-danger{background:#dc2626;color:#fff}
    .small{font-size:12px;color:#556}
    .list{margin-top:12px}
    .item{padding:8px;border-radius:8px;border:1px solid #eef2ff;margin-bottom:8px;background:#fbfdff;display:flex;flex-direction:column}
    .meta{display:flex;justify-content:space-between;align-items:center}
    .controls{display:flex;gap:8px;margin-top:8px}
    .legend{display:flex;gap:10px;align-items:center;margin-top:12px;flex-wrap:wrap}
    .sw{width:18px;height:18px;border-radius:4px}
    footer.info{font-size:12px;color:#556;margin-top:12px}
    @media (max-width:900px){
      #app{flex-direction:column}
      .sidebar{width:100%;order:2;max-height:44vh;overflow:auto}
      .map-wrap{order:1;height:56vh}
    }

    /* minor style for list controls area */
    .list-controls{display:flex;gap:8px;align-items:center;margin-top:10px}
    .list-controls input{flex:1}
    .list-controls select{width:160px}
  </style>
</head>
<body>
  <header>
    <div style="width:28px;height:28px;display:flex;align-items:center;justify-content:center;background:#fff;border-radius:6px">üõ∞Ô∏è</div>
    <div class="title">Monitoring Area Kerja ‚Äî Citra Satelit (Izin Kerja)</div>
    <button id="toggleSave" title="Simpan/Restore" class="btn" style="background:#fff;border-radius:8px">üíæ</button>
  </header>

  <div id="app">
    <div class="sidebar" id="sidebar">
      <label>Nomor Registrasi Area</label>
      <input id="reg" placeholder="000/KPI49A10/IKP/XI/2025" />

      <label>Nomor Registrasi Izin Kerja</label>
      <input id="permit" placeholder="000/REG/HSE/XI/2025" />

      <label>Pekerjaan</label>
      <input id="name" placeholder="Pekerjaan Pengelasan" />
      
      <label>Tanggal Registrasi</label>
      <input id="regDate" type="date" />

      <label>Tanggal Kadaluarsa Izin (opsional)</label>
      <input id="expiry" type="date" />

      <label>Nama Perusahaan</label>
      <select id="company">
        <option value="">-- Pilih Perusahaan --</option>
        <option>PT PAMITRA JK</option>
        <option>PT PATRA TRADING</option>
        <option>PT PAMITRA MEKSIP</option>
        <option>PT PERTA MC</option>
        <option>PT APIK</option>
        <option>PT PATRA JASA</option>
        <option>PT ANUGRAH ASMAT</option>
      </select>

      <label>Lokasi Pekerjaan</label>
      <select id="location">
        <option value="">-- Pilih Lokasi --</option>
        <option>OM</option>
        <option>UTL</option>
        <option>CDU</option>
        <option>NHTU</option>
        <option>CRU</option>
        <option>Jetty 1</option>
        <option>Jetty 2</option>
        <option>Jetty 3</option>
        <option>Open Access</option>
        <option>Community/Mess TKJP</option>
        <option>Kantor</option>
        <option>Gudang Limbah</option>
        <option>Lain-Lain</option>
      </select>

      <!-- NEW: Jenis Izin Kerja -->
      <label>Jenis Izin Kerja</label>
      <select id="workType">
        <option value="">-- Pilih Jenis Izin --</option>
        <option>Dingin</option>
        <option>Panas</option>
        <option>Ketinggian</option>
        <option>Ruang Terbatas</option>
        <option>Angkat Angkut</option>
        <option>Bawah Air</option>
      </select>

      <!-- NEW: Status Izin -->
      <label>Status Izin</label>
      <select id="statusPermit">
        <option value="">-- Pilih Status Izin --</option>
        <option>Baru</option>
        <option>Perpanjang 1</option>
        <option>Perpanjang 2</option>
        <option>Perpanjang 3</option>
      </select>

      <div class="row">
        <div>
          <label>Latitude</label>
          <input id="lat" placeholder="-2.345678" />
        </div>
        <div>
          <label>Longitude</label>
          <input id="lng" placeholder="117.123456" />
        </div>
      </div>

      <label>Jenis Area</label>
      <select id="type">
        <option value="point">Titik (Point)</option>
        <option value="circle">Lingkaran (Circle)</option>
        <option value="polygon">Poligon (gambar)</option>
      </select>

      <label>Kritikalitas</label>
      <select id="crit">
        <option value="low">Low (Non-kritis)</option>
        <option value="medium">Medium (Pengawasan)</option>
        <option value="high">High (Kritis)</option>
      </select>

      <label>Radius (meter) ‚Äî untuk Lingkaran</label>
      <input id="radius" type="number" placeholder="50" />

      <div class="controls" style="margin-top:10px">
        <button id="addBtn" class="btn btn-primary">Tambah / Simpan</button>
        <button id="clearBtn" class="btn btn-danger">Hapus Semua</button>
      </div>

      <label style="margin-top:10px">Filter berdasarkan Status Izin</label>
      <select id="filterStatus">
        <option value="all">Tampilkan Semua</option>
        <option value="active">Active</option>
        <option value="expiring">Expiring &lt; 24 jam</option>
        <option value="expired">Expired</option>
        <option value="nodate">Tanpa Tanggal</option>
      </select>

      <!-- NEW: List search and location filter -->
      <div class="list-controls" style="margin-top:8px">
        <input id="search" placeholder="Cari pekerjaan (nama, izin, reg, perusahaan)..." />
        <select id="listLocationFilter" title="Filter Lokasi">
          <option value="all">Semua Lokasi</option>
          <option value="OM">OM</option>
          <option value="CDU">CDU</option>
          <option value="NHTU">NHTU</option>
          <option value="CRU">CRU</option>
          <option value="Jetty 1">Jetty 1</option>
          <option value="Jetty 2">Jetty 2</option>
          <option value="Jetty 3">Jetty 3</option>
          <option value="Open Access">Open Access</option>
          <option value="Community">Community</option>
          <option value="nodata">Tanpa Lokasi</option>
        </select>
      </div>

      <div class="legend">
        <div style="display:flex;gap:6px;align-items:center"><div class="sw" style="background:#60a5fa"></div><div class="small">Low</div></div>
        <div style="display:flex;gap:6px;align-items:center"><div class="sw" style="background:#f59e0b"></div><div class="small">Medium</div></div>
        <div style="display:flex;gap:6px;align-items:center"><div class="sw" style="background:#ef4444"></div><div class="small">High</div></div>
      </div>

      <div style="margin-top:12px;display:flex;gap:8px">
        <button id="exportCSV" class="btn">Export CSV</button>
        <button id="exportJSON" class="btn">Export JSON</button>
      </div>

      <div style="margin-top:8px;display:flex;gap:8px">
        <button id="importBtn" class="btn">Import JSON</button>
        <input type="file" id="fileInput" accept="application/json" style="display:none" />
      </div>

      <div class="list" id="list"></div>

      <div class="info footer">
        ‚Ä¢ Klik peta untuk mengisi koordinat.<br>
        ‚Ä¢ Gambar poligon gunakan tombol draw di pojok kiri peta.<br>
        ‚Ä¢ Data tersimpan otomatis ke browser (localStorage). Gunakan Export/Import untuk backup.<br>
        ‚Ä¢ Tanggal kadaluarsa izin dihitung berakhir pada jam 23:59 pada tanggal yang dipilih (izin tetap berlaku sepanjang hari tersebut).
      </div>
    </div>

    <div class="map-wrap">
      <div id="map"></div>
    </div>
  </div>

  <!-- SCRIPTS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>

  <script>
    // Helper
    const qs = id => document.getElementById(id);

    function colorForCrit(c){
      if(c==='high') return '#ef4444';
      if(c==='medium') return '#f59e0b';
      return '#60a5fa';
    }

    // derive a simple lokasi status: Onsite for facility locations, Offsite for Community/Open Access
    function locationStatusFor(loc){
      if(!loc) return '-';
      const offsite = ['Open Access','Community','Community/Mess TKJP'];
      return offsite.includes(loc) ? 'Offsite' : 'Onsite';
    }

    // compute status based on expiry date string (YYYY-MM-DD)
    // expiry is treated as ending at 23:59:59 on the expiry date (i.e. the permit is valid during the expiry date)
    function computeStatus(expiry){
      if(!expiry) return 'nodate';
      const now = new Date();
      const ed = new Date(expiry + 'T23:59:59');
      if(ed <= now) return 'expired';
      const diff = ed - now;
      if(diff <= 24*3600*1000) return 'expiring';
      return 'active';
    }

    // Map init
    const map = L.map('map', { fullscreenControl: true }).setView([-2.5, 117.0], 6);

    // Esri Satellite (no API key)
    L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
      maxZoom: 20,
      attribution: 'Tiles ¬© Esri'
    }).addTo(map);

    const drawnItems = new L.FeatureGroup().addTo(map);
    const drawControl = new L.Control.Draw({
      position: 'topleft',
      draw: {
        polygon: { allowIntersection: false, showArea: true, shapeOptions: { color: '#3388ff' } },
        polyline: false, rectangle: false, circle: false, marker: false
      },
      edit: { featureGroup: drawnItems, remove: true }
    });
    map.addControl(drawControl);

    // Data store
    let areas = [];
    const STORAGE_KEY = 'monitoring_areas_with_permit_v2'; // bump version to avoid conflicts
    let editingId = null; // id when editing an existing area

    // Load
    function loadFromStorage(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return;
        const parsed = JSON.parse(raw);
        if(Array.isArray(parsed)){
          parsed.forEach(item => addAreaToMap(item, false));
        }
      }catch(e){ console.warn('load error', e); }
    }

    function saveToStorage(){
      try{
        const out = areas.map(a => {
          // include hiddenByExpiry so state persists
          if(a.type==='polygon') return { id:a.id, reg:a.reg, regDate:a.regDate || null, permit:a.permit, name:a.name, company:a.company||null, type:'polygon', crit:a.crit, location:a.location||null, locationStatus:a.locationStatus||null, workType: a.workType || null, statusPermit: a.statusPermit || null, geojson:a.geojson, expiry:a.expiry, hiddenByExpiry: a.hiddenByExpiry ? true : false };
          return { id:a.id, reg:a.reg, regDate:a.regDate || null, permit:a.permit, name:a.name, company:a.company||null, location:a.location||null, locationStatus:a.locationStatus||null, type:a.type, crit:a.crit, workType: a.workType || null, statusPermit: a.statusPermit || null, lat:a.lat, lng:a.lng, radius:a.radius, expiry:a.expiry, hiddenByExpiry: a.hiddenByExpiry ? true : false };
        });
        localStorage.setItem(STORAGE_KEY, JSON.stringify(out));
      }catch(e){ console.warn('save error', e); }
    }

    // UI list
    function rebuildList(){
      const container = qs('list'); container.innerHTML = '';
      const filter = qs('filterStatus').value;
      const searchTerm = (qs('search').value || '').trim().toLowerCase();
      const locFilter = qs('listLocationFilter').value; // 'all' or specific or 'nodata'

      areas.forEach(a => {
        const status = computeStatus(a.expiry);

        // apply search + location filters for list display
        // Search matches reg, permit, name, company
        const combined = ((a.reg||'') + ' ' + (a.permit||'') + ' ' + (a.name||'') + ' ' + (a.company||'')).toLowerCase();
        if(searchTerm){
          if(!combined.includes(searchTerm)) {
            // doesn't match search -> skip
            return;
          }
        }

        // location filter
        if(locFilter && locFilter !== 'all'){
          if(locFilter === 'nodata'){
            if(a.location) return; // user wants only those without location
          } else {
            if(a.location !== locFilter) return;
          }
        }

        // apply status filter for list (if user selected)
        if(filter !== 'all' && filter !== status) return;

        const div = document.createElement('div'); div.className='item';
        const meta = document.createElement('div'); meta.className='meta';
        const regDateText = a.regDate ? ` ‚Ä¢ Reg: ${a.regDate}` : '';
        const statusText = status === 'nodate' ? 'Tanpa Tanggal' : (status==='active' ? 'Active' : (status==='expiring' ? 'Expiring (<24h)' : 'Expired'));
        // indicate if hidden on map due to expiry
        const hiddenNote = a.hiddenByExpiry ? ' ‚Ä¢ (dihilangkan dari peta: kadaluarsa)' : '';
        meta.innerHTML = `<div><strong>${a.reg||'(no)'} - ${a.name||'(tanpa nama)'}</strong>
                          <div class="small">Perusahaan: ${a.company||'-'} ‚Ä¢ Izin: ${a.permit||'-'} ‚Ä¢ ${a.type} ‚Ä¢ ${a.crit} ‚Ä¢ ${statusText}${hiddenNote}${regDateText}</div></div>`;
        const btns = document.createElement('div');
        const z = document.createElement('button'); z.className='btn'; z.textContent='Zoom';
        z.onclick = ()=> {
          if(a.type==='polygon' && a.layer){ map.fitBounds(a.layer.getBounds()); a.layer.openPopup && a.layer.openPopup(); }
          else if(a.layer && a.layer.getLatLng){ map.setView(a.layer.getLatLng(), 18); a.layer.openPopup && a.layer.openPopup(); }
          else if(a.lat && a.lng) map.setView([a.lat,a.lng], 18);
        };
        const e = document.createElement('button'); e.className='btn'; e.textContent='Edit';
        e.onclick = ()=> {
          qs('reg').value=a.reg||''; qs('regDate').value = a.regDate || '';
          qs('permit').value=a.permit||''; qs('name').value=a.name||'';
          qs('company').value=a.company||'';
          qs('location').value = a.location || '';
          qs('workType').value = a.workType || '';
          qs('statusPermit').value = a.statusPermit || '';
          qs('lat').value=a.lat||''; qs('lng').value=a.lng||''; qs('type').value=a.type; qs('crit').value=a.crit; qs('radius').value=a.radius||50;
          qs('expiry').value = a.expiry || '';
          editingId = a.id;
          window.scrollTo({top:0,behavior:'smooth'});
        };
        const d = document.createElement('button'); d.className='btn'; d.textContent='Hapus';
        d.onclick = ()=> {
          if(!confirm('Hapus area ini?')) return;
          removeArea(a.id);
        };
        [z,e,d].forEach(b=>{ b.style.marginLeft='6px'; btns.appendChild(b); });
        meta.appendChild(btns);
        div.appendChild(meta);

        if(a.type==='point' || a.type==='circle'){
          const p = document.createElement('div'); p.className='small'; p.style.marginTop='8px';
          p.textContent = `Lat: ${Number(a.lat).toFixed(6)} | Lng: ${Number(a.lng).toFixed(6)}${a.type==='circle' ? ' | R: '+(a.radius||50)+' m':''}`;
          // show regDate, lokasi and expiry below
          const info = document.createElement('div'); info.className='small'; info.style.marginTop='6px';
          info.textContent = `Perusahaan: ${a.company || '-'}  ‚Ä¢  Tanggal Registrasi: ${a.regDate || '-'}  ‚Ä¢  Lokasi: ${a.location || '-'}  ‚Ä¢  Status Lokasi: ${a.locationStatus || '-'}  ‚Ä¢  Jenis Izin: ${a.workType || '-'}  ‚Ä¢  Status Izin: ${a.statusPermit || '-'}  ‚Ä¢  Tenggat Izin: ${a.expiry || '-'}`;
          div.appendChild(p);
          div.appendChild(info);
        } else if(a.type==='polygon'){
          const p = document.createElement('div'); p.className='small'; p.style.marginTop='8px';
          p.textContent = 'Poligon (geojson)';
          const info = document.createElement('div'); info.className='small'; info.style.marginTop='6px';
          info.textContent = `Perusahaan: ${a.company || '-'}  ‚Ä¢  Tanggal Registrasi: ${a.regDate || '-'}  ‚Ä¢  Lokasi: ${a.location || '-'}  ‚Ä¢  Status Lokasi: ${a.locationStatus || '-'}  ‚Ä¢  Jenis Izin: ${a.workType || '-'}  ‚Ä¢  Status Izin: ${a.statusPermit || '-'}  ‚Ä¢  Tenggat Izin: ${a.expiry || '-'}`;
          div.appendChild(p);
          div.appendChild(info);
        }
        container.appendChild(div);
      });
    }

    function updateMapLayerVisibilityByFilter(){
      // keep map layer visibility in sync based on filterStatus, search and listLocationFilter
      const filter = qs('filterStatus').value;
      const searchTerm = (qs('search').value || '').trim().toLowerCase();
      const locFilter = qs('listLocationFilter').value;

      areas.forEach(a => {
        const status = computeStatus(a.expiry);
        let visible = (filter === 'all' || filter === status);

        // apply search: hide if not matching search (so map shows only visible items)
        if(visible && searchTerm){
          const combined = ((a.reg||'') + ' ' + (a.permit||'') + ' ' + (a.name||'') + ' ' + (a.company||'')).toLowerCase();
          if(!combined.includes(searchTerm)) visible = false;
        }

        // apply location filter
        if(visible && locFilter && locFilter !== 'all'){
          if(locFilter === 'nodata'){
            if(a.location) visible = false;
          } else {
            if(a.location !== locFilter) visible = false;
          }
        }

        // If area was hidden because expiry passed, ensure we don't re-add it
        if(a.hiddenByExpiry) visible = false;

        // toggle layer
        try{
          if(a.layer){
            if(visible && !map.hasLayer(a.layer)) map.addLayer(a.layer);
            if(!visible && map.hasLayer(a.layer)) map.removeLayer(a.layer);
          }
        }catch(e){}
      });
    }

    function removeArea(id){
      const idx = areas.findIndex(x=>x.id===id);
      if(idx===-1) return;
      const a = areas[idx];
      if(a.layer) map.removeLayer(a.layer);
      areas.splice(idx,1);
      saveToStorage();
      rebuildList();
      updateMapLayerVisibilityByFilter();
    }

    // Add area to map (and store)
    function addAreaToMap(obj, fit=true){
      const id = obj.id || String(Date.now()) + Math.random().toString(36).slice(2,8);
      let layer=null;
      const loc = obj.location || null;
      const locStatus = obj.locationStatus || locationStatusFor(loc);
      const workType = obj.workType || null;
      const statusPermit = obj.statusPermit || null;

      if(obj.type==='polygon' && obj.geojson){
        layer = L.geoJSON(obj.geojson, { style: { color: colorForCrit(obj.crit), weight: 2 } }).addTo(map);
        layer.eachLayer(l => l.bindPopup(`<b>${obj.reg||''} - ${obj.name||''}</b><br>Perusahaan: ${obj.company||'-'}<br>Izin: ${obj.permit||''}<br>${obj.crit}<br>Jenis Izin: ${workType||'-'}<br>Status Izin: ${statusPermit||'-'}<br>Expiry: ${obj.expiry||'-'}<br>Reg: ${obj.regDate||'-'}<br>Lokasi: ${loc||'-'} ‚Ä¢ ${locStatus}`));
      } else if(obj.type==='circle'){
        layer = L.circle([obj.lat,obj.lng], { radius: obj.radius||50, color: colorForCrit(obj.crit), fillOpacity: 0.18 }).addTo(map);
        layer.bindPopup(`<b>${obj.reg||''} - ${obj.name||''}</b><br>Perusahaan: ${obj.company||'-'}<br>Izin: ${obj.permit||''}<br>${obj.crit}<br>Jenis Izin: ${workType||'-'}<br>Status Izin: ${statusPermit||'-'}<br>Expiry: ${obj.expiry||'-'}<br>Reg: ${obj.regDate||'-'}<br>Lokasi: ${loc||'-'} ‚Ä¢ ${locStatus}`);
      } else { // point
        const iconHtml = `<div style="width:22px;height:22px;border-radius:50%;background:${colorForCrit(obj.crit)};box-shadow:0 0 0 3px rgba(255,255,255,.6);border:2px solid rgba(0,0,0,.1)"></div>`;
        const icon = L.divIcon({
          className: 'custom-icon',
          html: iconHtml,
          iconSize: [22,22],
          iconAnchor: [11,11]
        });
        layer = L.marker([obj.lat,obj.lng], { icon }).addTo(map);
        layer.bindPopup(`<b>${obj.reg||''} - ${obj.name||''}</b><br>Perusahaan: ${obj.company||'-'}<br>Izin: ${obj.permit||''}<br>${obj.crit}<br>Jenis Izin: ${workType||'-'}<br>Status Izin: ${statusPermit||'-'}<br>Expiry: ${obj.expiry||'-'}<br>Reg: ${obj.regDate||'-'}<br>Lokasi: ${loc||'-'} ‚Ä¢ ${locStatus}`);
      }

      // determine hiddenByExpiry at creation time
      const hiddenByExpiry = obj.expiry ? (computeStatus(obj.expiry) === 'expired') : false;
      if(hiddenByExpiry && layer && map.hasLayer(layer)){
        // remove from map but keep the layer reference so it can be restored if expiry changed
        try{ map.removeLayer(layer); }catch(e){}
      }

      const stored = { id, reg: obj.reg, regDate: obj.regDate || null, permit: obj.permit, name: obj.name, company: obj.company || null, type: obj.type, crit: obj.crit, location: loc, locationStatus: locStatus, workType: workType, statusPermit: statusPermit, lat: obj.lat, lng: obj.lng, radius: obj.radius, geojson: obj.geojson, layer, expiry: obj.expiry, hiddenByExpiry };
      areas.push(stored);

      if(fit && layer){
        try{
          if(obj.type==='polygon') map.fitBounds(layer.getBounds());
          else map.setView([obj.lat,obj.lng], 17);
        }catch(e){}
      }
      saveToStorage();
      rebuildList();
      updateMapLayerVisibilityByFilter();
    }

    // Update existing area (called when editing)
    function updateArea(id, data){
      const idx = areas.findIndex(a=>a.id===id);
      if(idx===-1) return;
      const old = areas[idx];
      // remove old layer
      if(old.layer) map.removeLayer(old.layer);
      // create new layer
      if(data.location && !data.locationStatus) data.locationStatus = locationStatusFor(data.location);
      const merged = Object.assign({}, old, data);
      const toAdd = Object.assign({}, merged);
      delete toAdd.layer;
      toAdd.id = id;
      areas.splice(idx,1);
      addAreaToMap(toAdd, true);
    }

    // New: hide/remove expired areas from map (but keep them in the areas array and storage)
    function pruneExpiredVisibility(){
      let changed = false;
      areas.forEach(a => {
        const status = computeStatus(a.expiry);
        if(status === 'expired'){
          if(a.layer && map.hasLayer(a.layer)){
            try{ map.removeLayer(a.layer); }catch(e){}
            a.hiddenByExpiry = true;
            changed = true;
          } else if(!a.layer){
            // nothing to do, but mark hidden for consistency
            a.hiddenByExpiry = true;
          }
        } else {
          // if previously hidden due to expiry but now active/expiring, restore to map if it should be visible
          if(a.hiddenByExpiry){
            // only re-add if map shouldn't be filtered out by user's current filters
            a.hiddenByExpiry = false; // unset first then rely on updateMapLayerVisibilityByFilter to add if appropriate
            changed = true;
          }
        }
      });
      if(changed) {
        saveToStorage();
        rebuildList();
        updateMapLayerVisibilityByFilter();
      }
    }

    // Form handling
    qs('addBtn').addEventListener('click', ()=>{
      const reg = qs('reg').value.trim();
      const regDate = qs('regDate').value || null;
      const permit = qs('permit').value.trim();
      const name = qs('name').value.trim();
      const company = qs('company').value || null;
      const location = qs('location').value || null;
      const locationStatus = locationStatusFor(location);
      const workType = qs('workType').value || null;
      const statusPermit = qs('statusPermit').value || null;
      const lat = parseFloat(qs('lat').value);
      const lng = parseFloat(qs('lng').value);
      const type = qs('type').value;
      const crit = qs('crit').value;
      const radius = parseFloat(qs('radius').value) || 50;
      const expiry = qs('expiry').value || null;

      if(type==='polygon'){
        alert('Poligon harus dibuat menggunakan draw tool pada peta (pojok kiri). Setelah menggambar, Anda akan diminta mengisi metadata (registrasi & izin).');
        return;
      }
      if(isNaN(lat) || isNaN(lng)){
        alert('Isi koordinat lat dan lng yang valid (contoh: -1.234567, 117.123456).');
        return;
      }

      if(editingId){
        updateArea(editingId, { reg, regDate, permit, name, company, location, locationStatus, type, crit, lat, lng, radius, expiry, workType, statusPermit });
        editingId = null;
        qs('addBtn').textContent = 'Tambah / Simpan';
        // after update, ensure expired visibility handled
        pruneExpiredVisibility();
        return;
      }

      addAreaToMap({ reg, regDate, permit, name, company, location, locationStatus, type, crit, lat, lng, radius, expiry, workType, statusPermit });
      // handle expiry right away
      pruneExpiredVisibility();
    });

    qs('clearBtn').addEventListener('click', ()=>{
      if(!confirm('Hapus semua area dari peta dan storage?')) return;
      areas.forEach(a => { if(a.layer) map.removeLayer(a.layer); });
      areas = [];
      localStorage.removeItem(STORAGE_KEY);
      rebuildList();
      updateMapLayerVisibilityByFilter();
    });

    // Click map to fill coords
    map.on('click', e => {
      const { lat, lng } = e.latlng;
      qs('lat').value = lat.toFixed(6);
      qs('lng').value = lng.toFixed(6);
    });

    // Handle drawn polygon
    map.on(L.Draw.Event.CREATED, function (event) {
      const layer = event.layer;
      const geojson = layer.toGeoJSON();
      const reg = prompt('Nomor Registrasi area (contoh AR-001):') || '';
      let regDate = prompt('Tanggal Registrasi (YYYY-MM-DD) ‚Äî kosongkan jika tidak ada:','') || '';
      if(regDate && !/^\d{4}-\d{2}-\d{2}$/.test(regDate)){
        alert('Format tanggal registrasi tidak valid. Simpan tanpa tanggal. (gunakan YYYY-MM-DD)');
        regDate = '';
      }
      const permit = prompt('Nomor Registrasi Izin Kerja:') || '';
      const name = prompt('Nama area / pekerjaan:') || 'Poligon Area';
      // ask company from list (show comma separated options)
      let company = prompt('Nama Perusahaan (mis. PT PAMITRA, PT PATRA TRADING, PT PAMITRA MEKSIP, PT PERTA MC, PT APIK, PT PATRA JASA, PT ANUGRAH ASMAT):','') || '';
      if(company) company = company.trim();
      // ask location from the same list
      let location = prompt('Lokasi Pekerjaan (OM, CDU, NHTU, CRU, Jetty 1, Jetty 2, Jetty 3, Open Access, Community):','') || '';
      if(location && !['OM','CDU','NHTU','CRU','Jetty 1','Jetty 2','Jetty 3','Open Access','Community'].includes(location)){
        const normalized = location.trim();
        if(!['OM','CDU','NHTU','CRU','Jetty 1','Jetty 2','Jetty 3','Open Access','Community'].includes(normalized)){
          if(!confirm('Lokasi tidak dikenali. Simpan tanpa lokasi?')) location = '';
          else location = '';
        } else {
          location = normalized;
        }
      }
      const locationStatus = locationStatusFor(location);
      let crit = prompt('Kritikalitas (low/medium/high):', 'medium') || 'medium';
      if(!['low','medium','high'].includes(crit)) crit='medium';
      // ask expiry for polygon
      let expiry = prompt('Tanggal kadaluarsa izin (YYYY-MM-DD) ‚Äî kosongkan jika tidak ada:','') || '';
      if(expiry && !/^\d{4}-\d{2}-\d{2}$/.test(expiry)){
        alert('Format tanggal tidak valid. Simpan tanpa tanggal. (gunakan YYYY-MM-DD)');
        expiry = '';
      }
      // NEW: ask workType and statusPermit for polygon
      let workType = prompt('Jenis Izin Kerja (Dingin, Panas, Ketinggian, Ruang Terbatas, Angkat Angkut, Bawah Air):','') || '';
      if(workType) workType = workType.trim();
      let statusPermit = prompt('Status Izin (Baru, Perpanjang 1, Perpanjang 2, Perpanjang 3):','') || '';
      if(statusPermit) statusPermit = statusPermit.trim();

      layer.setStyle({ color: colorForCrit(crit) });
      layer.bindPopup(`<b>${reg} - ${name}</b><br>Perusahaan: ${company||'-'}<br>Izin: ${permit}<br>${crit}<br>Jenis Izin: ${workType||'-'}<br>Status Izin: ${statusPermit||'-'}<br>Expiry: ${expiry||'-'}<br>Reg: ${regDate||'-'}<br>Lokasi: ${location||'-'} ‚Ä¢ ${locationStatus}`);
      drawnItems.addLayer(layer);

      addAreaToMap({ reg, regDate: regDate || null, permit, name, company: company || null, location: location || null, locationStatus, type:'polygon', crit, geojson, expiry, workType, statusPermit });
      pruneExpiredVisibility();
    });

    map.on('draw:deleted', function(e){
      const layers = e.layers;
      layers.eachLayer(l => {
        const gj = l.toGeoJSON();
        const idx = areas.findIndex(a => a.type==='polygon' && a.geojson && JSON.stringify(a.geojson.geometry.coordinates) === JSON.stringify(gj.geometry.coordinates));
        if(idx!==-1){
          areas[idx].layer && map.removeLayer(areas[idx].layer);
          areas.splice(idx,1);
        }
      });
      saveToStorage();
      rebuildList();
      updateMapLayerVisibilityByFilter();
    });

    // Export CSV/JSON & Import
    qs('exportCSV').addEventListener('click', ()=>{
      const rows = [['id','reg','regDate','permit','name','company','location','locationStatus','workType','statusPermit','type','crit','lat','lng','radius','expiry','geojson','hiddenByExpiry']];
      areas.forEach(a=>{
        rows.push([a.id||'', a.reg||'', a.regDate||'', a.permit||'', a.name||'', a.company||'', a.location||'', a.locationStatus||'', a.workType||'', a.statusPermit||'', a.type||'', a.crit||'', a.lat||'', a.lng||'', a.radius||'', a.expiry||'', a.geojson ? JSON.stringify(a.geojson) : '', a.hiddenByExpiry ? '1' : '0']);
      });
      const csv = rows.map(r => r.map(c => {
        const s = String(c===undefined||c===null ? '' : c);
        if(s.includes('"') || s.includes(',') || s.includes('\n')) {
          return `"${s.replace(/"/g,'""')}` + '"';
        }
        return s;
      }).join(',')).join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download='areas_with_permit.csv'; a.click(); URL.revokeObjectURL(url);
    });

    qs('exportJSON').addEventListener('click', ()=>{
      const out = areas.map(a=>{
        if(a.type==='polygon') return { id:a.id, reg:a.reg, regDate:a.regDate || null, permit:a.permit, name:a.name, company:a.company||null, location:a.location||null, locationStatus:a.locationStatus||null, workType:a.workType||null, statusPermit:a.statusPermit||null, type:'polygon', crit:a.crit, geojson:a.geojson, expiry:a.expiry, hiddenByExpiry: a.hiddenByExpiry ? true : false };
        return { id:a.id, reg:a.reg, regDate:a.regDate || null, permit:a.permit, name:a.name, company:a.company||null, location:a.location||null, locationStatus:a.locationStatus||null, workType:a.workType||null, statusPermit:a.statusPermit||null, type:a.type, crit:a.crit, lat:a.lat, lng:a.lng, radius:a.radius, expiry:a.expiry, hiddenByExpiry: a.hiddenByExpiry ? true : false };
      });
      const blob = new Blob([JSON.stringify(out, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download='areas_with_permit.json'; a.click(); URL.revokeObjectURL(url);
    });

    qs('importBtn').addEventListener('click', ()=> qs('fileInput').click());
    qs('fileInput').addEventListener('change', (e)=>{
      const f = e.target.files[0]; if(!f) return;
      const r = new FileReader();
      r.onload = ()=> {
        try{
          const parsed = JSON.parse(r.result);
          if(!Array.isArray(parsed)) throw 'Format JSON harus array';
          areas.forEach(a=> a.layer && map.removeLayer(a.layer));
          areas = [];
          parsed.forEach(p => addAreaToMap(p, false));
          saveToStorage();
          rebuildList();
          updateMapLayerVisibilityByFilter();
          alert('Import sukses.');
        }catch(err){
          alert('Gagal import JSON: '+err);
        }
      };
      r.readAsText(f);
    });

    // Toggle save button
    qs('toggleSave').addEventListener('click', ()=>{
      if(confirm('Restore data dari localStorage? (OK = reload untuk restore, Cancel = export current ke JSON)')){
        location.reload();
      } else {
        qs('exportJSON').click();
      }
    });

    // Filter change
    qs('filterStatus').addEventListener('change', ()=>{
      updateMapLayerVisibilityByFilter();
      rebuildList();
    });

    // NEW: search and list location filter listeners
    qs('search').addEventListener('input', ()=>{
      rebuildList();
      updateMapLayerVisibilityByFilter();
    });
    qs('listLocationFilter').addEventListener('change', ()=>{
      rebuildList();
      updateMapLayerVisibilityByFilter();
    });

    // Initial sample or load persisted
    const firstRunKey = 'monitoring_first_run_with_permit_v2';
    if(!localStorage.getItem(firstRunKey)){
      const sample = [
        { reg:'WK-001', regDate:'2025-10-01', permit:'IZIN-001-2025', name:'Hot Work - T-101', company:'PT PAMITRA', location:'OM', type:'point', crit:'high', lat:-1.1710, lng:131.8640, expiry:null, workType:'Panas', statusPermit:'Baru' },
        { reg:'WK-002', regDate:'2025-10-05', permit:'IZIN-002-2025', name:'Confined Space - V-201', company:'PT PATRA TRADING', location:'CDU', type:'point', crit:'medium', lat:-1.1716, lng:131.8631, expiry:null, workType:'Ruang Terbatas', statusPermit:'Perpanjang 1' },
        { reg:'WK-003', regDate:'2025-10-07', permit:'IZIN-003-2025', name:'Working at Height - Stack', company:'PT PERTA MC', location:'Jetty 1', type:'circle', crit:'high', lat:-1.1721, lng:131.8650, radius:40, expiry:null, workType:'Ketinggian', statusPermit:'Baru' }
      ];
      sample.forEach(s => addAreaToMap(s, false));
      localStorage.setItem(firstRunKey, '1');
    } else {
      loadFromStorage();
    }

    // ensure expired items are removed from map on startup
    pruneExpiredVisibility();

    // periodic check (every minute) to hide any areas that just expired while the app is open
    setInterval(pruneExpiredVisibility, 60*1000);

    rebuildList();
    updateMapLayerVisibilityByFilter();
  </script>

  <!-- START: Floating Due-24h Panel -->
  <style>
    /* Floating panel styling */
    #floatingDuePanel{
      position: fixed;
      right: 18px;
      bottom: 18px;
      width: 320px;
      max-height: 420px;
      background: #ffffff;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(2,6,23,0.18);
      overflow: hidden;
      display:flex;
      flex-direction:column;
      z-index: 10000;
      font-family: Inter, Roboto, Arial, sans-serif;
      border: 1px solid rgba(15,23,42,0.06);
    }
    #floatingDueHeader{
      padding: 10px 12px;
      background: linear-gradient(90deg, rgba(11,94,215,0.95), rgba(8,78,180,0.95));
      color: #fff;
      cursor: grab;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
    }
    #floatingDueHeader .title{font-weight:600;font-size:14px}
    #floatingDueHeader .controls{display:flex;gap:6px;align-items:center}
    #floatingDueList{
      padding: 8px;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      background: linear-gradient(180deg, #fbfdff, #ffffff);
    }
    .due-item{
      padding:8px;border-radius:8px;margin-bottom:8px;border:1px solid #eef2ff;display:flex;gap:8px;align-items:flex-start;
    }
    .due-color{width:10px;height:10px;border-radius:3px;margin-top:6px}
    .due-main{flex:1}
    .due-title{font-weight:600;font-size:13px}
    .due-sub{font-size:12px;color:#4b5563;margin-top:4px}
    .due-time{font-size:12px;font-weight:700;margin-left:8px;white-space:nowrap}
    #floatingDueEmpty{padding:12px;color:#475569;font-size:13px}
    .small-btn{background:transparent;border:none;color:#fff;padding:6px;border-radius:6px;cursor:pointer;font-size:13px}
    .minimized{height:40px;max-height:40px;width:220px}
    @media (max-width:640px){
      #floatingDuePanel{right:10px;left:10px;width:auto;bottom:12px}
    }
  </style>

  <div id="floatingDuePanel" aria-live="polite" role="region">
    <div id="floatingDueHeader">
      <div class="title">Tenggat &lt;= 24 jam (<span id="dueCount">0</span>)</div>
      <div class="controls">
        <button id="refreshDue" class="small-btn" title="Refresh">üîÑ</button>
        <button id="minimizeDue" class="small-btn" title="Minimize/Restore">‚Äî</button>
        <button id="closeDue" class="small-btn" title="Tutup">‚úï</button>
      </div>
    </div>
    <div id="floatingDueList" style="display:block">
      <div id="floatingDueEmpty">Mencari pekerjaan dengan tenggat kurang dari 24 jam...</div>
    </div>
  </div>

  <script>
  (function(){
    // Safety: try to access areas and map from outer scope
    const getAreas = ()=>{ try{ if(typeof areas !== 'undefined') return areas; }catch(e){} try{ if(window.areas) return window.areas; }catch(e){} return []; };
    const getMap = ()=> { try{ if(typeof map !== 'undefined') return map;}catch(e){} try{ if(window.map) return window.map;}catch(e){} return null; };

    const panel = document.getElementById('floatingDuePanel');
    const list = document.getElementById('floatingDueList');
    const empty = document.getElementById('floatingDueEmpty');
    const dueCountEl = document.getElementById('dueCount');
    const refreshBtn = document.getElementById('refreshDue');
    const minimizeBtn = document.getElementById('minimizeDue');
    const closeBtn = document.getElementById('closeDue');

    const dateKeys = ['expiry','due','dueDate','deadline','due_at','finish_by','due_date','finishBy', 'eta_finish', 'dueUntil'];

    function parsePossibleDate(v){
      if(!v) return null;
      if(v instanceof Date && !isNaN(v)) return v;
      if(typeof v === 'number' && !isNaN(v)) {
        const d = new Date(v);
        if(!isNaN(d)) return d;
      }
      if(typeof v === 'string'){
        const isoDateOnly = v.match(/^(\d{4}-\d{2}-\d{2})$/);
        if(isoDateOnly){
          const d = new Date(isoDateOnly[1] + 'T23:59:59');
          if(!isNaN(d)) return d;
        }
        let d = new Date(v);
        if(!isNaN(d)) return d;
        d = new Date(v.replace(' ', 'T'));
        if(!isNaN(d)) return d;
        const m = v.match(/^(\d{1,2})[-\/](\d{1,2})[-\/](\d{2,4})$/);
        if(m){
          let day = m[1].padStart(2,'0'), mon = m[2].padStart(2,'0'), yr = m[3];
          if(yr.length===2) yr = '20'+yr;
          d = new Date(yr + '-' + mon + '-' + day + 'T23:59:59');
          if(!isNaN(d)) return d;
        }
      }
      return null;
    }

    function getDueDateFromArea(a){
      for(const k of dateKeys){
        if(k in a){
          const d = parsePossibleDate(a[k]);
          if(d) return d;
        }
      }
      const candidates = [a.permit, a.name, (a.reg||'')];
      for(const txt of candidates){
        if(!txt || typeof txt !== 'string') continue;
        const iso = txt.match(/(20\d{2}-\d{2}-\d{2})/);
        if(iso) { const d = parsePossibleDate(iso[1]); if(d) return d; }
        const ymd = txt.match(/(\d{4}\/\d{2}\/\d{2})/);
        if(ymd) { const d = parsePossibleDate(ymd[1].replace(/\//g,'-')); if(d) return d; }
        const short = txt.match(/(\d{2}[-\/]\d{2}[-\/]\d{2,4})/);
        if(short) { const d = parsePossibleDate(short[1]); if(d) return d; }
      }
      return null;
    }

    function formatRemaining(ms){
      if(ms < 0) return 'telah lewat';
      const s = Math.floor(ms/1000);
      const h = Math.floor(s/3600);
      const m = Math.floor((s%3600)/60);
      if(h>0) return `${h}j ${m}m`;
      if(m>0) return `${m}m`;
      return `${s}s`;
    }

    function colorForCrit(c){
      if(c==='high') return '#ef4444';
      if(c==='medium') return '#f59e0b';
      return '#60a5fa';
    }

    function buildList(){
      const now = Date.now();
      const areasList = getAreas() || [];
      const dueItems = [];

      for(const a of areasList){
        const due = getDueDateFromArea(a);
        if(!due) continue;
        const diff = due.getTime() - now;

        if(diff <= 24*3600*1000 && diff >= 0){ // within next 24h (exclude past)
          dueItems.push({area:a, due, diff});
        }
      }

      // sort by soonest
      dueItems.sort((x,y)=> x.diff - y.diff);

      // render
      list.innerHTML = '';
      if(dueItems.length === 0){
        empty.textContent = 'Tidak ada pekerjaan dengan tenggat <= 24 jam.';
        list.appendChild(empty);
        dueCountEl.textContent = '0';
        return;
      }

      dueCountEl.textContent = String(dueItems.length);
      for(const it of dueItems){
        const a = it.area;
        const wrapper = document.createElement('div'); wrapper.className = 'due-item';
        const color = document.createElement('div'); color.className='due-color'; color.style.background = colorForCrit(a.crit);
        const main = document.createElement('div'); main.className='due-main';
        const title = document.createElement('div'); title.className='due-title'; title.textContent = `${a.reg || '(no)'} ‚Äî ${a.name || '(tanpa nama)'}`;
        const sub = document.createElement('div'); sub.className='due-sub';
        const dueStr = it.due.toLocaleString();
        sub.innerHTML = `Perusahaan: ${a.company || '-'} ‚Ä¢ Izin: ${a.permit || '-'} ‚Ä¢ Lokasi: ${a.location || '-'} ‚Ä¢ Status Lokasi: ${a.locationStatus || '-'} ‚Ä¢ Jenis Izin: ${a.workType || '-'} ‚Ä¢ Status Izin: ${a.statusPermit || '-'} ‚Ä¢ ${a.type || '-'} ‚Ä¢ ${a.crit || '-' }<br><span style="font-weight:600">Tenggat: ${dueStr}</span>`;
        const time = document.createElement('div'); time.className='due-time'; time.textContent = formatRemaining(it.diff);
        // action: click -> zoom
        wrapper.style.cursor = 'pointer';
        wrapper.onclick = (e)=>{
          e.stopPropagation();
          const mp = getMap();
          try{
            if(!mp) { alert('Peta belum tersedia.'); return; }
            if(a.type==='polygon' && a.layer){
              mp.fitBounds(a.layer.getBounds());
              a.layer && a.layer.openPopup && a.layer.openPopup();
            } else if(a.layer && a.layer.getLatLng){
              const ll = a.layer.getLatLng();
              mp.setView([ll.lat, ll.lng], 18);
              a.layer.openPopup && a.layer.openPopup();
            } else if(a.lat && a.lng){
              mp.setView([a.lat, a.lng], 17);
            } else {
              alert('Lokasi area tidak tersedia untuk zoom.');
            }
          }catch(err){
            console.warn('zoom error',err);
          }
        };

        main.appendChild(title);
        main.appendChild(sub);
        wrapper.appendChild(color);
        wrapper.appendChild(main);
        wrapper.appendChild(time);
        list.appendChild(wrapper);
      }
    }

    // initial build
    buildList();

    // auto-refresh every minute to update remaining times & new data
    let intervalId = setInterval(buildList, 60*1000);

    // manual refresh
    refreshBtn.addEventListener('click', ()=> buildList());

    // minimize / restore
    let minimized = false;
    minimizeBtn.addEventListener('click', ()=>{
      minimized = !minimized;
      if(minimized){
        panel.classList.add('minimized');
        document.getElementById('floatingDueList').style.display = 'none';
        minimizeBtn.textContent = '+';
      } else {
        panel.classList.remove('minimized');
        document.getElementById('floatingDueList').style.display = 'block';
        minimizeBtn.textContent = '‚Äî';
      }
    });

    // close
    closeBtn.addEventListener('click', ()=>{
      panel.style.display = 'none';
      clearInterval(intervalId);
    });

    // Draggable implementation (pointer events)
    (function makeDraggable(handle, el){
      let dragging=false, startX=0, startY=0, origX=0, origY=0;
      handle.style.touchAction = 'none';
      handle.addEventListener('pointerdown', (ev)=>{
        const interactive = ev.target && (ev.target.closest && ev.target.closest('button, input, a, select, textarea'));
        if(interactive) return;
        dragging = true;
        handle.setPointerCapture && handle.setPointerCapture(ev.pointerId);
        startX = ev.clientX; startY = ev.clientY;
        const rect = el.getBoundingClientRect();
        origX = rect.left; origY = rect.top;
        handle.style.cursor = 'grabbing';
      });
      window.addEventListener('pointermove', (ev)=>{
        if(!dragging) return;
        const dx = ev.clientX - startX;
        const dy = ev.clientY - startY;
        let nx = origX + dx;
        let ny = origY + dy;
        const pad = 12;
        const w = el.offsetWidth, h = el.offsetHeight;
        nx = Math.max(pad, Math.min(window.innerWidth - w - pad, nx));
        ny = Math.max(pad, Math.min(window.innerHeight - h - pad, ny));
        el.style.left = nx + 'px';
        el.style.top = ny + 'px';
        el.style.right = 'auto';
        el.style.bottom = 'auto';
      });
      window.addEventListener('pointerup', (ev)=>{
        if(dragging) {
          dragging = false;
          try{ handle.releasePointerCapture && handle.releasePointerCapture(ev.pointerId); }catch(e){}
          handle.style.cursor = 'grab';
        }
      });
      handle.addEventListener('dragstart', (ev)=> ev.preventDefault());
    })(document.getElementById('floatingDueHeader'), panel);

    panel.style.right = '18px';
    panel.style.bottom = '18px';
    panel.style.left = 'auto';
    panel.style.top = 'auto';

    window.addEventListener('storage', (e)=>{
      if(e.key && (e.key.includes('monitoring_areas') || e.key.includes('monitoring_first_run'))){
        try{ buildList(); }catch(e){}
      }
    });

    window.refreshDuePanel = buildList;

  })();
  </script>
  <!-- END: Floating Due-24h Panel -->

</body>
</html>
